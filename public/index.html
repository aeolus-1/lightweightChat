<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandy and Warm Beaches</title>
    <style>
        body {
            overflow: hidden;
            line-height: 95%;
        }
        ::-webkit-scrollbar {
            display: none;
        }

        .full {
            width:100%;
            height: calc(100vh - 75px);
        }
        .sub_section {
            display: inline-block;
        }

        .msg_input {
            width: 50vw;
        }
        .chat_id {
            font-size: 6px;
            margin-bottom: -10px;
        }
        .chat_msg_section {
            margin-right: 15px;
            display: inline-block;
            word-wrap: break-word;
            min-width: 50px;
        }

        .chat_container {
            overflow-y: scroll;
            max-height: calc(100vh - 75px);
            bottom: 0%;
            position: absolute;
            width: 100%;
        }
        .chat_display {
            position: relative;
        }
        .chat_msg {
            margin-top: 1px;
        }
        .name_display {
            line-height: 70%;
        }
        .chat_submission {
            background-color: white;
            height: 50px;
        }

        #msg {
            font-size: large;
        }
        .chat_img {
            max-width: 500px;
            max-height: 200px;
        }
        .server_msg {
            color: rgb(255, 0, 0);    
        }

    </style>
    <script src="/libs/socket.io.min.js"></script>
    <script src="../public/libs/socket.io.min.js"></script>
</head>
<body>
    <div class="full chat_display">
        <div class="chat_container" id="chat_container">
            
        </div>
    </div>
    <hr>
    <div class="chat_submission">
        <div class="sub_section">
            username<br>
            <input name="username" class="name_input" id="name_input" type="text">
        </div>
        <div class="sub_section">
            message<br>
            <input class="msg_input" id="msg_input" type="text">
        </div>
        <div class="sub_section">
            <button id="submission">Submit</button>
        </div>
        <div class="sub_section" style="float: right;">
            <p id="usersOnline">Users Online: ?</p>
            </div>
    </div>

    <script>
/*
message {
    msg;
    username;
    id;
    timestamp;
}
*/
        const SERVER_URL = "https://warmsandybeaches.net"
            //hello????
        var hasReceivedHistory = false

        document.getElementById("name_input").value = localStorage.getItem("username")||""
        document.getElementById("name_input").onchange = ()=>{localStorage.setItem("username",document.getElementById("name_input").value);socket.emit("updateUsername", localStorage.getItem("username"))}


        //https://stackoverflow.com/questions/9714525/javascript-image-url-verify
        function testImage(url, callback, timeout) {
            timeout = timeout || 5000;
            var timedOut = false, timer;
            var img = new Image();
            img.onerror = img.onabort = function() {
                if (!timedOut) {
                    clearTimeout(timer);
                    callback(url, "error");
                }
            };
            img.onload = function() {
                if (!timedOut) {
                    clearTimeout(timer);
                    callback(url, "success");
                }
            };
            img.src = url;
            timer = setTimeout(function() {
                timedOut = true;
                // reset .src to invalid URL so it stops previous
                // loading, but doesn't trigger new load
                img.src = "//!!!!/test.jpg";
                callback(url, "timeout");
            }, timeout); 
        }

        function findUrls(text) {
            var urlRegex = /(https?:\/\/[^\s]+)/g,
                urls = []
            let ntext = text.replace(urlRegex, function(url) {
                let elementId = Math.floor(Math.random()*10e10)
                urls.push({
                    link:url,
                    eleId:elementId,
                })

                
                return `<span id="${elementId}">${url}</span>`
            })

            console.log(urls)
            return {url:urls,text:ntext}
          }

        function appendToChat(msg) {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = msg.msg
            msg.msg = tmp.textContent || tmp.innerText || ""

            var div = document.createElement('div'),
            htmlString = `<div class="chat_msg">
                <div class="chat_msg_section">
                    <span id="time">14:30</span>
                </div>
                <div class="chat_msg_section name_display">
                    <span class="chat_id">
                        <span id="id">15673478</span>
                    </span><br>
                    <b class="chat_username">
                        <span id="username">reef</span>
                    </b>
                </div>
                <div class="chat_msg_section">
                    <span id="msg">messsage messsage messsage messsage messsage messsage </span>
                </div>
            </div>`
            div.innerHTML = htmlString.trim();
            div = div.firstChild
            console.log(div)

            let date = new Date(msg.timestamp),
                time = date.toLocaleTimeString()

            div.children[0].children[0].textContent = time
            div.children[1].children[0].children[0].textContent = msg.id
            div.children[1].children[2].children[0].textContent = msg.username
            if (msg.serverMsg) {
                div.children[1].children[2].children[0].classList.add("server_msg")
            }

            
            div.children[2].children[0].textContent = msg.msg
            let furls = findUrls(msg.msg),
                urls = furls.url

            

            
                
            div.children[2].children[0].innerHTML = furls.text
            if (urls!=undefined) {
                for(let i=0;i<urls.length;i++) {
                    console.log("testing img", urls[i])
                    testImage(urls[i].link, (a,b)=>{
                        if (b=="success") {
                            let img = document.createElement("img")
                            img.src = a
                            console.log("inseting", a)
                            img.classList.add("chat_img")
                            div.appendChild(document.createElement("br"))
                            div.appendChild(img)
                            document.getElementById(urls[i].eleId).style.display = "none"
                            img.onload = ()=>{
                                document.getElementById("chat_container").scrollTop += img.offsetHeight*1.2
                            }
                        }
                    })
                }
            }

            let innerSpan = div.children[2].children[0]
            console.log(innerSpan.innerHTML)
            div.children[2].children[0].innerHTML = innerSpan.innerHTML.replace("@"+document.getElementsByClassName("name_input")[0].value, (e)=>{
                return `<span style="background-color: yellow;">${e}</span>`
            })
            div.children[2].children[0].innerHTML = innerSpan.innerHTML.replace("@everyone", (e)=>{
                return `<span style="background-color: yellow;">${e}</span>`
            })
            
        
            document.getElementById("chat_container").appendChild(div)
            document.getElementById("chat_container").scrollTop += div.offsetHeight*1.4
            
        }

        function submitToChat(msg) {
            socket.emit("submitChat", JSON.stringify({msg:msg,key:localStorage.getItem("key")}))
        }


        document.getElementById("submission").onclick = ()=>{
            if (document.getElementsByClassName("msg_input")[0].value == null || document.getElementsByClassName("msg_input")[0].value.trim() === '') return
            var msg = {
                msg:document.getElementsByClassName("msg_input")[0].value,
                username:document.getElementsByClassName("name_input")[0].value,
                id: 0,
                timestamp:(new Date()).getTime(),
            }
            document.getElementsByClassName("msg_input")[0].value = ""

            submitToChat(msg)
        }
        document.getElementById("msg_input").addEventListener("keyup",(e)=>{
            if (e.code=="Enter"){
                document.getElementById("submission").click()
            }
        })




        
        const socket = io(SERVER_URL, {
            reconnection: true,
        })

        socket.on("connect", () => {
            socket.emit("updateUsername", {"username":localStorage.getItem("username"),"joined": true})
        });

        socket.on("appendChat", (data)=>{
            data = JSON.parse(data)

            if (data.isHistoryMsgs) {
                if (hasReceivedHistory) return 0
            }
            
            for(let i=0;i<data.msgs.length;i++) {
                appendToChat(data.msgs[i])
            }
            
        })

        socket.on("updateUsersOnline", (count)=>{
            document.getElementById("usersOnline").textContent = `Users Online: ${count}`
        })

        socket.on("forceReload", ()=>{
            location.reload()
        })
        socket.on("modifyUsername", (data)=>{
            data = JSON.parse(data)
            if (document.getElementById("name_input").value == data.curName) {
                document.getElementById("name_input").value = data.newName
                console.log(`username modified to ${data.newName}`)
            }
            
        })

    </script>
</body>
</html>
